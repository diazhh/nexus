<!--

    Copyright Â© 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="pf-alarms-list-container">
  <!-- Alarm Summary Cards -->
  <div class="alarm-summary-cards">
    <mat-card class="summary-card critical" (click)="onSeverityFilterChange([PfAlarmSeverity.CRITICAL])">
      <mat-card-content>
        <div class="count">{{ alarmCount.critical }}</div>
        <div class="label">Critical</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card high" (click)="onSeverityFilterChange([PfAlarmSeverity.HIGH])">
      <mat-card-content>
        <div class="count">{{ alarmCount.high }}</div>
        <div class="label">High</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card medium" (click)="onSeverityFilterChange([PfAlarmSeverity.MEDIUM])">
      <mat-card-content>
        <div class="count">{{ alarmCount.medium }}</div>
        <div class="label">Medium</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card low" (click)="onSeverityFilterChange([PfAlarmSeverity.LOW])">
      <mat-card-content>
        <div class="count">{{ alarmCount.low }}</div>
        <div class="label">Low</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card total" (click)="clearFilters()">
      <mat-card-content>
        <div class="count">{{ alarmCount.total }}</div>
        <div class="label">Total Active</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline">
          <mat-label>Severity</mat-label>
          <mat-select [value]="severityFilter" (selectionChange)="onSeverityFilterChange($event.value)" multiple>
            <mat-option [value]="PfAlarmSeverity.CRITICAL">Critical</mat-option>
            <mat-option [value]="PfAlarmSeverity.HIGH">High</mat-option>
            <mat-option [value]="PfAlarmSeverity.MEDIUM">Medium</mat-option>
            <mat-option [value]="PfAlarmSeverity.LOW">Low</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [value]="statusFilter" (selectionChange)="onStatusFilterChange($event.value)" multiple>
            <mat-option [value]="PfAlarmStatus.ACTIVE_UNACK">Active (Unack)</mat-option>
            <mat-option [value]="PfAlarmStatus.ACTIVE_ACK">Active (Ack)</mat-option>
            <mat-option [value]="PfAlarmStatus.CLEARED_UNACK">Cleared (Unack)</mat-option>
            <mat-option [value]="PfAlarmStatus.CLEARED_ACK">Cleared (Ack)</mat-option>
          </mat-select>
        </mat-form-field>

        <span class="spacer"></span>

        <button mat-raised-button
                color="primary"
                [disabled]="selection.selected.length === 0"
                (click)="acknowledgeSelected()">
          <mat-icon>check</mat-icon>
          Acknowledge Selected ({{ selection.selected.length }})
        </button>

        <button mat-button (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Alarms Table -->
  <mat-card class="table-card">
    <mat-card-content>
      <div class="table-container" [class.loading]="isLoading">
        <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

        <table mat-table [dataSource]="dataSource" class="alarms-table">

          <!-- Checkbox Column -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox
                (change)="$event ? masterToggle() : null"
                [checked]="selection.hasValue() && isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let alarm">
              <mat-checkbox
                (click)="$event.stopPropagation()"
                (change)="$event ? selection.toggle(alarm) : null"
                [checked]="selection.isSelected(alarm)">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Severity Column -->
          <ng-container matColumnDef="severity">
            <th mat-header-cell *matHeaderCellDef>Severity</th>
            <td mat-cell *matCellDef="let alarm">
              <div class="severity-badge" [style.background-color]="getSeverityColor(alarm.severity)">
                {{ alarm.severity }}
              </div>
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Alarm Type</th>
            <td mat-cell *matCellDef="let alarm">
              <span class="alarm-type">{{ formatAlarmType(alarm.type) }}</span>
            </td>
          </ng-container>

          <!-- Originator Column -->
          <ng-container matColumnDef="originatorName">
            <th mat-header-cell *matHeaderCellDef>Well</th>
            <td mat-cell *matCellDef="let alarm">
              <a class="well-link" (click)="viewWellDetails(alarm); $event.stopPropagation()">
                {{ alarm.originatorName || 'Unknown' }}
              </a>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let alarm">
              <mat-chip [class.active]="isActive(alarm.status)" [class.cleared]="!isActive(alarm.status)">
                {{ getStatusLabel(alarm.status) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Start Time Column -->
          <ng-container matColumnDef="startTs">
            <th mat-header-cell *matHeaderCellDef>Start Time</th>
            <td mat-cell *matCellDef="let alarm">
              {{ alarm.startTs | date:'medium' }}
            </td>
          </ng-container>

          <!-- Message Column -->
          <ng-container matColumnDef="message">
            <th mat-header-cell *matHeaderCellDef>Message</th>
            <td mat-cell *matCellDef="let alarm">
              <span class="alarm-message">{{ alarm.details?.message || '-' }}</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let alarm">
              <button mat-icon-button
                      matTooltip="Acknowledge"
                      [disabled]="alarm.status === PfAlarmStatus.ACTIVE_ACK || alarm.status === PfAlarmStatus.CLEARED_ACK"
                      (click)="acknowledgeAlarm(alarm); $event.stopPropagation()">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button
                      matTooltip="Clear"
                      [disabled]="!isActive(alarm.status)"
                      (click)="clearAlarm(alarm); $event.stopPropagation()">
                <mat-icon>clear</mat-icon>
              </button>
              <button mat-icon-button
                      matTooltip="View Well"
                      (click)="viewWellDetails(alarm); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.active-alarm]="isActive(row.status)"
              [class.critical]="row.severity === PfAlarmSeverity.CRITICAL">
          </tr>
        </table>

        <!-- Empty State -->
        <div *ngIf="!isLoading && dataSource.data.length === 0" class="empty-state">
          <mat-icon>notifications_off</mat-icon>
          <p>No alarms found</p>
          <p class="hint">Adjust your filters to see more alarms</p>
        </div>
      </div>

      <mat-paginator
        [length]="totalElements"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
