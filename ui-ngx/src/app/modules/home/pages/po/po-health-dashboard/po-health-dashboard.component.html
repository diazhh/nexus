<!--

    Copyright Â© 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="po-health-dashboard-container">
  <!-- Summary Cards -->
  <div class="summary-section" *ngIf="summary">
    <div class="summary-cards">
      <mat-card class="summary-card total">
        <mat-card-content>
          <div class="stat-value">{{ summary.totalWells }}</div>
          <div class="stat-label">Total Wells</div>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card avg-score">
        <mat-card-content>
          <div class="stat-value">{{ summary.averageScore | number:'1.0-0' }}</div>
          <div class="stat-label">Average Score</div>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card at-risk" [class.alert]="summary.wellsAtRisk > 0">
        <mat-card-content>
          <div class="stat-value">{{ summary.wellsAtRisk }}</div>
          <div class="stat-label">Wells at Risk</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Health Distribution -->
    <mat-card class="distribution-card">
      <mat-card-header>
        <mat-card-title>Health Distribution</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="distribution-bars">
          <div class="dist-item" *ngFor="let level of [HealthLevel.EXCELLENT, HealthLevel.GOOD, HealthLevel.FAIR, HealthLevel.POOR, HealthLevel.CRITICAL]"
               (click)="onLevelFilterChange([level])">
            <div class="dist-label">{{ HealthLevelLabels[level] }}</div>
            <div class="dist-bar-container">
              <div class="dist-bar"
                   [style.width.%]="(summary.byLevel[level] / summary.totalWells * 100)"
                   [style.background-color]="getLevelColor(level)">
              </div>
            </div>
            <div class="dist-count">{{ summary.byLevel[level] || 0 }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Wells at Risk Panel -->
  <mat-card class="at-risk-card" *ngIf="wellsAtRisk.length > 0">
    <mat-card-header>
      <mat-card-title>
        <mat-icon color="warn">warning</mat-icon>
        Wells Requiring Attention
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="at-risk-list">
        <div class="at-risk-item" *ngFor="let well of wellsAtRisk" (click)="viewWellDetails(well)">
          <div class="well-info">
            <div class="well-name">{{ well.wellName || well.wellId }}</div>
            <div class="failure-prob" *ngIf="well.failureProbability">
              Failure Risk: {{ formatPercent(well.failureProbability) }}
            </div>
          </div>
          <div class="score-display">
            <div class="score-value" [style.color]="getLevelColor(well.level)">{{ well.score }}</div>
            <mat-icon [style.color]="getTrendColor(well.trend)">{{ getTrendIcon(well.trend) }}</mat-icon>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline">
          <mat-label>Health Level</mat-label>
          <mat-select [value]="levelFilter" (selectionChange)="onLevelFilterChange($event.value)" multiple>
            <mat-option [value]="HealthLevel.EXCELLENT">Excellent</mat-option>
            <mat-option [value]="HealthLevel.GOOD">Good</mat-option>
            <mat-option [value]="HealthLevel.FAIR">Fair</mat-option>
            <mat-option [value]="HealthLevel.POOR">Poor</mat-option>
            <mat-option [value]="HealthLevel.CRITICAL">Critical</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Trend</mat-label>
          <mat-select [value]="trendFilter" (selectionChange)="onTrendFilterChange($event.value)" multiple>
            <mat-option [value]="HealthTrend.IMPROVING">Improving</mat-option>
            <mat-option [value]="HealthTrend.STABLE">Stable</mat-option>
            <mat-option [value]="HealthTrend.DECLINING">Declining</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-slide-toggle [checked]="showOnlyAtRisk" (change)="toggleAtRiskFilter()">
          Show only at-risk wells
        </mat-slide-toggle>

        <span class="spacer"></span>

        <button mat-raised-button color="primary" (click)="recalculateAll()">
          <mat-icon>refresh</mat-icon>
          Recalculate All
        </button>

        <button mat-button (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Health Scores Table -->
  <mat-card class="table-card">
    <mat-card-content>
      <div class="table-container" [class.loading]="isLoading">
        <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

        <table mat-table [dataSource]="dataSource" class="health-table">

          <!-- Well Name Column -->
          <ng-container matColumnDef="wellName">
            <th mat-header-cell *matHeaderCellDef>Well</th>
            <td mat-cell *matCellDef="let score">
              <a class="well-link" (click)="viewWellDetails(score); $event.stopPropagation()">
                {{ score.wellName || score.wellId }}
              </a>
            </td>
          </ng-container>

          <!-- Score Column -->
          <ng-container matColumnDef="score">
            <th mat-header-cell *matHeaderCellDef>Score</th>
            <td mat-cell *matCellDef="let score">
              <div class="score-bar-container">
                <div class="score-bar" [style.background]="getScoreGradient(score.score)"></div>
                <span class="score-value">{{ score.score }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Level Column -->
          <ng-container matColumnDef="level">
            <th mat-header-cell *matHeaderCellDef>Level</th>
            <td mat-cell *matCellDef="let score">
              <mat-chip [style.background-color]="getLevelColor(score.level)" class="level-chip">
                {{ HealthLevelLabels[score.level] }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Trend Column -->
          <ng-container matColumnDef="trend">
            <th mat-header-cell *matHeaderCellDef>Trend</th>
            <td mat-cell *matCellDef="let score">
              <div class="trend-display" [style.color]="getTrendColor(score.trend)">
                <mat-icon>{{ getTrendIcon(score.trend) }}</mat-icon>
                <span>{{ score.trend }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Failure Probability Column -->
          <ng-container matColumnDef="failureProbability">
            <th mat-header-cell *matHeaderCellDef>Failure Risk</th>
            <td mat-cell *matCellDef="let score">
              <span class="failure-prob" [class.high]="score.failureProbability > 0.5">
                {{ formatPercent(score.failureProbability) }}
              </span>
            </td>
          </ng-container>

          <!-- Estimated Days Column -->
          <ng-container matColumnDef="estimatedDays">
            <th mat-header-cell *matHeaderCellDef>Est. Days to Failure</th>
            <td mat-cell *matCellDef="let score">
              <span *ngIf="score.estimatedDaysToFailure" [class.urgent]="score.estimatedDaysToFailure < 30">
                {{ score.estimatedDaysToFailure }} days
              </span>
              <span *ngIf="!score.estimatedDaysToFailure">-</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let score">
              <button mat-icon-button matTooltip="View Well" (click)="viewWellDetails(score); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Recalculate" (click)="recalculateWell(score); $event.stopPropagation()">
                <mat-icon>refresh</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.at-risk]="isAtRisk(row)"
              (click)="viewWellDetails(row)">
          </tr>
        </table>

        <!-- Empty State -->
        <div *ngIf="!isLoading && dataSource.data.length === 0" class="empty-state">
          <mat-icon>favorite</mat-icon>
          <p>No health scores found</p>
          <p class="hint">Click "Recalculate All" to generate health scores</p>
        </div>
      </div>

      <mat-paginator
        [length]="totalElements"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
