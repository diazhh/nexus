<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<div class="rv-dialog-container ipr-dialog">
  <h2 mat-dialog-title>
    <mat-icon>show_chart</mat-icon> {{ isEditMode ? 'Editar Modelo IPR' : 'Nuevo Modelo IPR' }}
  </h2>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="form">
      <div class="section-title">Informacion Basica</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Nombre del Modelo</mat-label>
          <input matInput formControlName="name" required>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Codigo</mat-label>
          <input matInput formControlName="modelCode">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Pozo</mat-label>
          <mat-select formControlName="wellAssetId" required>
            <mat-option value="">Seleccione...</mat-option>
            <mat-option *ngFor="let w of wells" [value]="w.assetId">{{ w.name }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Completacion</mat-label>
          <mat-select formControlName="completionAssetId">
            <mat-option value="">Seleccione...</mat-option>
            <mat-option *ngFor="let c of completions" [value]="c.assetId">{{ c.name }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Fecha de Analisis</mat-label>
          <input matInput [matDatepicker]="analysisDatePicker" formControlName="analysisDate">
          <mat-datepicker-toggle matSuffix [for]="analysisDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #analysisDatePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="section-title">Metodo IPR</div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Metodo de Analisis</mat-label>
          <mat-select formControlName="iprMethod" required>
            <mat-option *ngFor="let method of iprMethods" [value]="method">
              {{ iprMethodLabels[method] }}
            </mat-option>
          </mat-select>
          <mat-hint>Seleccione el metodo apropiado segun las condiciones del yacimiento</mat-hint>
        </mat-form-field>
      </div>

      <div class="section-title">Condiciones del Yacimiento</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Presion del Yacimiento (psi)</mat-label>
          <input matInput type="number" formControlName="reservoirPressurePsi" required>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Presion de Burbuja (psi)</mat-label>
          <input matInput type="number" formControlName="bubblePointPressurePsi">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Temperatura (°F)</mat-label>
          <input matInput type="number" formControlName="reservoirTemperatureF">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-slide-toggle formControlName="isBelowBubblePoint">
          ¿Presion debajo del punto de burbuja?
        </mat-slide-toggle>
      </div>

      <div class="section-title">Datos de Prueba</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Fecha de Prueba</mat-label>
          <input matInput [matDatepicker]="testDatePicker" formControlName="testDate">
          <mat-datepicker-toggle matSuffix [for]="testDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #testDatePicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Tipo de Prueba</mat-label>
          <mat-select formControlName="testType">
            <mat-option value="PRODUCTION_TEST">Prueba de Produccion</mat-option>
            <mat-option value="BUILDUP">Buildup</mat-option>
            <mat-option value="DST">DST</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Tasa de Prueba (bopd)</mat-label>
          <input matInput type="number" formControlName="testRateBopd">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Pwf de Prueba (psi)</mat-label>
          <input matInput type="number" formControlName="testPwfPsi">
        </mat-form-field>
      </div>

      <div class="section-title">Indices de Productividad</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>PI Total (bpd/psi)</mat-label>
          <input matInput type="number" step="0.01" formControlName="productivityIndexBpdPsi">
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="form.get('isBelowBubblePoint')?.value">
          <mat-label>PI Arriba de Pb (bpd/psi)</mat-label>
          <input matInput type="number" step="0.01" formControlName="productivityIndexAbovePb">
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="form.get('isBelowBubblePoint')?.value">
          <mat-label>PI Debajo de Pb (bpd/psi)</mat-label>
          <input matInput type="number" step="0.01" formControlName="productivityIndexBelowPb">
        </mat-form-field>
      </div>

      <!-- Fetkovich-specific fields -->
      <div *ngIf="showFetkovichFields()">
        <div class="section-title">Parametros de Fetkovich</div>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Coeficiente C</mat-label>
            <input matInput type="number" step="0.0001" formControlName="fetkovichC">
            <mat-hint>De la ecuacion q = C * (Pr² - Pwf²)ⁿ</mat-hint>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Exponente n</mat-label>
            <input matInput type="number" step="0.01" formControlName="fetkovichN">
            <mat-hint>Tipicamente entre 0.5 (turbulento) y 1.0 (laminar)</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Jones-specific fields -->
      <div *ngIf="showJonesFields()">
        <div class="section-title">Parametros de Jones</div>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Parametro A</mat-label>
            <input matInput type="number" step="0.0001" formControlName="jonesA">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Parametro B</mat-label>
            <input matInput type="number" step="0.0001" formControlName="jonesB">
          </mat-form-field>
        </div>
      </div>

      <div class="section-title">Resultados (Calculados)</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Qmax (bopd)</mat-label>
          <input matInput type="number" formControlName="qmaxBopd" readonly>
          <mat-hint>Calculado automaticamente al aplicar el metodo IPR</mat-hint>
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="form.get('iprMethod')?.value === 'VOGEL'">
          <mat-label>Coeficiente de Vogel</mat-label>
          <input matInput type="number" formControlName="vogelCoefficient" readonly>
        </mat-form-field>
      </div>

      <div class="section-title">Punto de Operacion Actual</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Pwf Actual (psi)</mat-label>
          <input matInput type="number" formControlName="currentPwfPsi">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Tasa Actual (bopd)</mat-label>
          <input matInput type="number" formControlName="currentRateBopd">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Eficiencia Operacional (%)</mat-label>
          <input matInput type="number" step="0.1" formControlName="operatingEfficiencyPercent">
        </mat-form-field>
      </div>

      <div class="section-title">Dano de Formacion</div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Factor de Skin</mat-label>
          <input matInput type="number" step="0.1" formControlName="skinFactor">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Razon de Dano</mat-label>
          <input matInput type="number" step="0.01" formControlName="damageRatio">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Eficiencia de Flujo</mat-label>
          <input matInput type="number" step="0.01" formControlName="flowEfficiency">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Qmax Ideal (sin dano) (bopd)</mat-label>
          <input matInput type="number" formControlName="idealQmaxBopd">
          <mat-hint>Potencial teorico sin dano de formacion</mat-hint>
        </mat-form-field>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="cancel()" [disabled]="isLoading">Cancelar</button>
    <button mat-raised-button color="primary" (click)="save()" [disabled]="form.invalid || isLoading">
      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
      <span *ngIf="!isLoading">{{ isEditMode ? 'Actualizar' : 'Guardar' }}</span>
    </button>
  </mat-dialog-actions>
</div>
