# ThingsBoard ML Integration Setup

## Overview

This guide explains how to configure ThingsBoard to integrate with the Nexus ML Service for real-time failure prediction, anomaly detection, and health scoring.

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ThingsBoard   │───>│     Kafka       │───>│   ML Service    │
│  (Telemetry)    │    │  (Message Bus)  │    │  (Predictions)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                                              │
        │                                              │
        v                                              v
┌─────────────────┐                          ┌─────────────────┐
│   PostgreSQL    │<─────────────────────────│   ML Models     │
│   (Timeseries)  │                          │   (MLflow)      │
└─────────────────┘                          └─────────────────┘
```

## Prerequisites

1. ThingsBoard CE/PE 3.5+ running
2. Kafka cluster (provided in docker-compose)
3. ML Service running (port 8090)

## Step 1: Configure Kafka in ThingsBoard

Add to your ThingsBoard configuration (`thingsboard.yml`):

```yaml
# Kafka settings
queue:
  type: kafka
  kafka:
    bootstrap.servers: "localhost:9092"
    replication_factor: 1
    topic-properties:
      rule-engine: "tb.rule-engine"
```

Or via environment variables:

```bash
export TB_QUEUE_TYPE=kafka
export TB_KAFKA_SERVERS=localhost:9092
```

## Step 2: Import Rule Chains

### ML Telemetry Pipeline

1. Go to **Rule Chains** in ThingsBoard UI
2. Click **Import Rule Chain**
3. Upload `ml_telemetry_rule_chain.json`
4. Update Kafka bootstrap servers if needed
5. Save and activate

### ML Prediction Alarms

1. Import `ml_alarm_rule_chain.json`
2. Update ML Service URL if not on localhost:8090
3. Save and activate

## Step 3: Connect Rule Chains

1. Edit your **Root Rule Chain**
2. Add a **Rule Chain** node linking to "ML Telemetry Pipeline"
3. Connect after the "Save Timeseries" node
4. Set connection type to "Success"

## Step 4: Configure Asset Profiles

For wells that should be monitored by ML:

1. Go to **Asset Profiles** > Select well profile
2. Under **Rule Chain**, select "ML Telemetry Pipeline"
3. Save

## Step 5: Test the Integration

### Send Test Telemetry

```bash
# Via ThingsBoard REST API
curl -X POST "http://localhost:8080/api/v1/DEVICE_ACCESS_TOKEN/telemetry" \
  -H "Content-Type: application/json" \
  -d '{
    "pump_intake_pressure_psi": 1250,
    "pump_discharge_pressure_psi": 3500,
    "motor_current_amps": 45.5,
    "motor_temperature_f": 185,
    "vibration_in_s": 0.15,
    "flow_rate_bpd": 850
  }'
```

### Verify in ML Service

```bash
# Check Kafka consumer stats
curl http://localhost:8090/api/v1/kafka/stats

# Check health
curl http://localhost:8090/api/v1/health
```

## Kafka Topics

| Topic | Description |
|-------|-------------|
| `tb.rule-engine.telemetry` | Well telemetry for ML processing |
| `tb.rule-engine.alarms` | Alarms generated by ML predictions |

## Telemetry Keys

The ML service expects these telemetry keys for ESP wells:

| Key | Unit | Description |
|-----|------|-------------|
| `pump_intake_pressure_psi` | PSI | Pump intake pressure |
| `pump_discharge_pressure_psi` | PSI | Pump discharge pressure |
| `motor_current_amps` | Amps | Motor current |
| `motor_voltage_v` | Volts | Motor voltage |
| `motor_temperature_f` | °F | Motor temperature |
| `vibration_in_s` | in/s | Vibration level |
| `flow_rate_bpd` | BPD | Production flow rate |
| `gas_oil_ratio` | scf/bbl | GOR |
| `water_cut_percent` | % | Water cut |
| `frequency_hz` | Hz | VFD frequency |

## Troubleshooting

### No messages in Kafka

1. Check ThingsBoard logs for Kafka connection errors
2. Verify Kafka is running: `docker-compose ps`
3. Check topic exists: `kafka-topics --list --bootstrap-server localhost:9092`

### ML Service not receiving messages

1. Check Kafka consumer status in ML service logs
2. Verify topic name matches in both ThingsBoard and ML service
3. Check network connectivity between containers

### Alarms not being created

1. Verify prediction probability exceeds threshold (0.7)
2. Check alarm rule chain is activated
3. Review ThingsBoard rule engine logs

## Support

For issues, check:
- ML Service logs: `docker-compose logs ml-service`
- ThingsBoard logs: Check ThingsBoard installation logs
- Kafka UI: http://localhost:8089
